{% extends 'temp.html'%} {% block title %} Главная страница {% endblock %} {%
block script %}
<!-- <script src="http://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script> -->
<script src="https://api-maps.yandex.ru/2.0-stable/?apikey=5595cc61-5dc4-4943-bc23-3bbc15bd35c5&load=package.full&lang=ru-RU" type="text/javascript"></script>
<script type="text/javascript">
  ymaps.ready(init);
  var myMap;
  function init(coord=[55.76, 37.64]) {
    myMap = new ymaps.Map("myMap", {
      center: coord,
      zoom: 7
    });

    var myPlaceMark = new ymaps.Placemark(coord, {
      iconContent: ' ', // текст на иконке
    }, {
      present: 'twirl#redStretchyIcon' // тип иконки
    });
    myMap.geoObjects.add(myPlaceMark);
  }

  function update(coords) {
    myMap.setCenter(coords);
    var myPlaceMark = new ymaps.Placemark(coords, {
      iconContent: ' ', // текст на иконке
    }, {
      present: 'twirl#redStretchyIcon' // тип иконки
    });
    myMap.geoObjects.add(myPlaceMark);
  }

</script>
{% endblock%} {% block body %}
<div class="left_side">
  <h2>Фильтр:</h2>
  <form>
    <p>
      <label class="cat_input" for="date">с: </label>
      <input type="date" class="cat_input" id="date1" name="date" value="{{ l_d }}"/>
    </p>
    <p>
      <label class="cat_input" for="date"> по: </label>
      <input type="date" class="cat_input" id="date2" name="date" value="{{ r_d }}"/>
    </p>
    <br />
    <p>
      <br />Упорядочить по местоположению?
      <input type="checkbox" id="place_order" {% if order_loc %} checked {% endif %} name="html5"/>
    </p>
    <p>
      <button type="submit" onclick="updateForm()">Поиск</button>
    </p>
  </form>
  <script>
    
    function updateForm() {
      var left_date = document.getElementById("date1").value;
      var right_date = document.getElementById("date2").value;
      var order = document.getElementById("place_order").checked;
      var data = "" + left_date + "/" + right_date + "/" + order;
      $.post("/process_data/", {'data':data});
    }

  </script>
  <form>
    <div class="scrollable">
      <table>
        {% for i in range(strings|length) %}
        <tr data-unique-id="{{ i }}">
          <td><a href="#" class="string-link">{{ strings[i] }}</a></td>
        </tr>
        {% endfor %}
      </table>
    </div>
    <script>
        var articles = {{ articles | safe}};
        var places = {{ places | safe }}
        document.querySelectorAll('.string-link').forEach(item => {
            item.addEventListener('click', event => {
                // Обработчик нажатия на каждую строку
              var uniqueId = parseInt(event.target.closest('tr').dataset.uniqueId, 10);
              // alert('Вы нажали на строку с уникальным ID: ' + uniqueId);
              var article = articles[uniqueId];
              document.getElementById('field_text').textContent = article;
              var place = places[uniqueId];
              // const Http = new XMLHttpRequest();
              const url = "https://catalog.api.2gis.com/3.0/items/geocode?q=" + place +
               "&fields=items.point,items.geometry.centroid&key=9f2242fe-2ba0-47d1-a46f-2003c5a99fc7";
              // Http.open("GET", url);
              // Http.send();
              // Http.onreadystatechange = (e) => {
              //   console.log(Http.responseText);  // => получим массив данных в формате JSON
              // }
              let result;
              $.get(url, function(data, status) {
                code = data.meta.code;
                if (Number(code) > 199 && Number(code) < 300) {
                  result = data.result.items[0].geometry.centroid;
                  latitude = result.slice(6,15);
                  longitude = result.slice(-10, -1);
                  document.getElementById('latitude').textContent = latitude;
                  document.getElementById('longitude').textContent = longitude;
                  update([longitude, latitude]);
                } else {
                  alert("error: can't decode place into coordinate.\nwarning! longitude and latitude belong to the last selected text");
                }
              });
            });
        });
    </script>
    <br /><br /><br /><br /><br /><br /><br />
    <div class="chosen_text" id="field_text">
      <p>Здесь будет отображаться выбранный текст.</p>
      <!-- <p>{{ articles[0] }}</p> -->
    </div>
  </form>
  <p class="coord">
    <span>Ширина: <label id="latitude">37.617774</label></span>
    <br/>
    <span>Долгота: <label id="longitude">55.755836</label></span>
  </p>
</div>
{% endblock %} {% block maps%}
<div id="myMap"></div>
{% endblock %}